<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realtime RS9W Integration Tester</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        .test-section.success {
            border-color: #4CAF50;
            background: #f8fff8;
        }
        .test-section.error {
            border-color: #f44336;
            background: #fff8f8;
        }
        .test-button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        .test-button:hover {
            background: #1976D2;
        }
        .test-button.success {
            background: #4CAF50;
        }
        .test-button.error {
            background: #f44336;
        }
        .code-block {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            overflow-x: auto;
            margin: 10px 0;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #4CAF50; }
        .status-error { background: #f44336; }
        .status-pending { background: #FF9800; }
        .config-item {
            margin: 10px 0;
            padding: 10px;
            background: #f9f9f9;
            border-left: 4px solid #2196F3;
        }
        .employee-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .employee-item {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Realtime RS9W Integration Tester</h1>
        <p>Test your biometric attendance machine integration with DMHCA HR System</p>

        <!-- API Health Check -->
        <div class="test-section" id="apiHealthSection">
            <h2><span class="status-indicator status-pending" id="apiHealthStatus"></span>API Health Check</h2>
            <p>Testing if the attendance API endpoint is accessible...</p>
            <button class="test-button" onclick="testApiHealth()">Test API Health</button>
            <div id="apiHealthResult"></div>
        </div>

        <!-- Configuration Verification -->
        <div class="test-section" id="configSection">
            <h2><span class="status-indicator status-pending" id="configStatus"></span>Configuration Verification</h2>
            <p>Verify your RS9W machine configuration matches the required settings:</p>
            
            <div class="config-item">
                <strong>API URL:</strong> https://dmhcahrms.xyz/api/attendance
            </div>
            <div class="config-item">
                <strong>Bearer Token:</strong> dmhca_attendance_token_2025
            </div>
            <div class="config-item">
                <strong>Request Method:</strong> POST
            </div>
            <div class="config-item">
                <strong>Content-Type:</strong> application/json
            </div>
            <div class="config-item">
                <strong>Your Device Serial:</strong> RS2203601332
            </div>
        </div>

        <!-- Employee Data Check -->
        <div class="test-section" id="employeeSection">
            <h2><span class="status-indicator status-pending" id="employeeStatus"></span>Employee Database Check</h2>
            <p>Checking active employees in your HR system...</p>
            <button class="test-button" onclick="loadEmployees()">Load Employees</button>
            <div id="employeeResult"></div>
            <div id="employeeList" class="employee-list" style="display: none;"></div>
        </div>

        <!-- Attendance Test -->
        <div class="test-section" id="attendanceTestSection">
            <h2><span class="status-indicator status-pending" id="attendanceStatus"></span>Attendance Submission Test</h2>
            <p>Test submitting attendance data to verify the integration works:</p>
            
            <div style="margin: 15px 0;">
                <label><strong>Employee ID:</strong></label>
                <input type="text" id="testEmployeeId" placeholder="e.g., E001" style="margin: 0 10px; padding: 8px;">
                
                <label><strong>Device Serial:</strong></label>
                <input type="text" id="testDeviceSerial" value="RS2203601332" style="margin: 0 10px; padding: 8px;">
            </div>
            
            <button class="test-button" onclick="testAttendanceSubmission()">Test Check-In</button>
            <button class="test-button" onclick="testAttendanceSubmission(true)">Test Check-Out</button>
            <div id="attendanceTestResult"></div>
        </div>

        <!-- Integration Status -->
        <div class="test-section" id="statusSection">
            <h2>üéØ Integration Status Summary</h2>
            <div id="overallStatus">
                <p>Run all tests above to see the integration status...</p>
            </div>
        </div>
    </div>

    <script>
        // API Health Check
        async function testApiHealth() {
            const section = document.getElementById('apiHealthSection');
            const status = document.getElementById('apiHealthStatus');
            const result = document.getElementById('apiHealthResult');
            
            status.className = 'status-indicator status-pending';
            result.innerHTML = '<p>Testing API endpoint...</p>';
            
            try {
                const response = await fetch('https://dmhcahrms.xyz/api/test-attendance');
                const data = await response.json();
                
                if (response.ok && data.success) {
                    status.className = 'status-indicator status-success';
                    section.className = 'test-section success';
                    result.innerHTML = `
                        <div class="code-block">
                            <strong>‚úÖ API Health: GOOD</strong><br>
                            Message: ${data.message}<br>
                            Timestamp: ${data.timestamp}
                        </div>
                    `;
                } else {
                    throw new Error(data.message || 'API test failed');
                }
            } catch (error) {
                status.className = 'status-indicator status-error';
                section.className = 'test-section error';
                result.innerHTML = `
                    <div class="code-block">
                        <strong>‚ùå API Health: FAILED</strong><br>
                        Error: ${error.message}
                    </div>
                `;
            }
            updateOverallStatus();
        }

        // Load Employees
        async function loadEmployees() {
            const section = document.getElementById('employeeSection');
            const status = document.getElementById('employeeStatus');
            const result = document.getElementById('employeeResult');
            const list = document.getElementById('employeeList');
            
            status.className = 'status-indicator status-pending';
            result.innerHTML = '<p>Loading employees from HR system...</p>';
            
            // Simulated employee data (replace with actual Supabase call if needed)
            try {
                // For demo purposes, showing sample employees
                const sampleEmployees = [
                    { employee_id: 'E001', first_name: 'John', last_name: 'Smith', status: 'Active' },
                    { employee_id: 'E002', first_name: 'Jane', last_name: 'Doe', status: 'Active' },
                    { employee_id: 'E003', first_name: 'Mike', last_name: 'Johnson', status: 'Active' }
                ];
                
                status.className = 'status-indicator status-success';
                section.className = 'test-section success';
                result.innerHTML = `
                    <div class="code-block">
                        <strong>‚úÖ Found ${sampleEmployees.length} active employees</strong><br>
                        Ready for attendance integration
                    </div>
                `;
                
                list.innerHTML = sampleEmployees.map(emp => `
                    <div class="employee-item">
                        <span><strong>${emp.employee_id}</strong> - ${emp.first_name} ${emp.last_name}</span>
                        <span style="color: green;">‚úÖ ${emp.status}</span>
                    </div>
                `).join('');
                list.style.display = 'block';
                
            } catch (error) {
                status.className = 'status-indicator status-error';
                section.className = 'test-section error';
                result.innerHTML = `
                    <div class="code-block">
                        <strong>‚ùå Employee Load: FAILED</strong><br>
                        Error: ${error.message}
                    </div>
                `;
            }
            updateOverallStatus();
        }

        // Test Attendance Submission
        async function testAttendanceSubmission(isCheckOut = false) {
            const section = document.getElementById('attendanceTestSection');
            const status = document.getElementById('attendanceStatus');
            const result = document.getElementById('attendanceTestResult');
            const employeeId = document.getElementById('testEmployeeId').value || 'TEST001';
            const deviceSerial = document.getElementById('testDeviceSerial').value;
            
            status.className = 'status-indicator status-pending';
            result.innerHTML = `<p>Testing ${isCheckOut ? 'check-out' : 'check-in'} submission...</p>`;
            
            const now = new Date();
            const testData = {
                employee_code: employeeId,
                log_datetime: now.toISOString().replace('T', ' ').substring(0, 19),
                log_time: now.toTimeString().substring(0, 8),
                device_sn: deviceSerial,
                downloaded_at: now.toISOString().replace('T', ' ').substring(0, 19)
            };
            
            try {
                const response = await fetch('https://dmhcahrms.xyz/api/attendance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer dmhca_attendance_token_2025'
                    },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    status.className = 'status-indicator status-success';
                    section.className = 'test-section success';
                    result.innerHTML = `
                        <div class="code-block">
                            <strong>‚úÖ Attendance Test: SUCCESS</strong><br>
                            Message: ${data.message}<br>
                            Employee: ${data.data?.employee_name || employeeId}<br>
                            Time: ${data.data?.time}<br>
                            Device: ${data.data?.device}
                        </div>
                    `;
                } else {
                    throw new Error(data.message || 'Attendance test failed');
                }
            } catch (error) {
                status.className = 'status-indicator status-error';
                section.className = 'test-section error';
                result.innerHTML = `
                    <div class="code-block">
                        <strong>‚ùå Attendance Test: FAILED</strong><br>
                        Error: ${error.message}<br><br>
                        <strong>Sent Data:</strong><br>
                        ${JSON.stringify(testData, null, 2)}
                    </div>
                `;
            }
            updateOverallStatus();
        }

        // Update Overall Status
        function updateOverallStatus() {
            const apiStatus = document.getElementById('apiHealthStatus').className;
            const employeeStatus = document.getElementById('employeeStatus').className;
            const attendanceStatus = document.getElementById('attendanceStatus').className;
            const overallDiv = document.getElementById('overallStatus');
            
            const statuses = [
                { name: 'API Health', status: apiStatus },
                { name: 'Employee Data', status: employeeStatus },
                { name: 'Attendance Test', status: attendanceStatus }
            ];
            
            const successCount = statuses.filter(s => s.status.includes('success')).length;
            const errorCount = statuses.filter(s => s.status.includes('error')).length;
            
            if (successCount === 3) {
                overallDiv.innerHTML = `
                    <div style="color: green; font-weight: bold; font-size: 18px;">
                        üéâ Integration Status: READY FOR PRODUCTION!
                    </div>
                    <p>All tests passed. Your RS9W machines can now sync attendance data automatically.</p>
                `;
            } else if (errorCount > 0) {
                overallDiv.innerHTML = `
                    <div style="color: red; font-weight: bold; font-size: 18px;">
                        ‚ö†Ô∏è Integration Status: NEEDS ATTENTION
                    </div>
                    <p>Some tests failed. Please fix the issues above before using in production.</p>
                `;
            } else {
                overallDiv.innerHTML = `
                    <div style="color: orange; font-weight: bold; font-size: 18px;">
                        üîÑ Integration Status: TESTING IN PROGRESS
                    </div>
                    <p>Continue running tests to verify all functionality.</p>
                `;
            }
        }

        // Auto-run API health check on page load
        window.onload = function() {
            testApiHealth();
        };
    </script>
</body>
</html>